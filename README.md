# Полезности для Shop-Script

## Показ дат создания и изменения товара

В карточке товара в бэкенде, в правой колонке показываются даты создания и последнего изменения товара. Показ можно
отключить или выбрать формат: показ даты или даты со временем

## Показ истории правок товара

В карточке товара появляется дополнительная вкладка с историей правок товара (выборка событий из общей ленты событий)

## Показ расчетной даты доставки администратору в заказе

Показ той даты доставки, которую насчитал плагин расчета стоимости, при просмотре заказа администратором. Если, конечно,
вообще какую-то дату он рассчитал.

## Информация о купоне по его ID

Хелпер, помогающий извлечь информацию о купоне, если известен его идентификатор. Например, в заказе хранится только
идентификатор использованного купона и нет возможности получить код и прочие данные о купоне.

Вызов хелпера:

    {$coupon_info = shopTipsPlugin::getCouponById(4)}
    
в примере цифра 4 это ID купона. Например в печатных формах можно получить ID использованного в заказе купона из
переменной `$order.params.coupon_id`. Обратите внимание, что во-первых в заказе может вовсе не быть купона, а
во-вторых купон может быть удален после оформления заказа.

**Возвращаемое значение**. Если купон найден, то возвращается массив формата ключ-значение:
    
* `code` - код купона
* `type` - тип. может быть строкой '%', 3-х символьным кодом валюты или '$FS'. Символ процента означает
  скидку в процентах, код валюты - скидку на сумму в указанной валюте, значение '$FS' - бесплатную доставку
* `limit` - ограничение на количество использований. Если ограничений нет, то `NULL`
* `used` - сколько раз использован купон. Таким образом, если *limit* не равно `NULL` и *used* равно или больше *limit*
  то купон неактивен
* `comment` - строка с комментарием к купону
* `extire_datetime` - ограничение по дате использования. Если ограничения по дате нет, то `NULL`

Пример кода для использования в печатной форме:

````smarty
{if !empty($order.params.coupon_id)}
    {$coupon_info = shopTipsPlugin::getCouponById($order.params.coupon_id)}
    {if !empty($coupon_info}
    <p>Использован купон <b>{$coupon_info['code']}</b></p>
    {/if}
{/if}
````

## Хук для добавления js и css в тег body

Для того чтобы загружать скрипты (и, если надо, стили) внутри тега body, обычно перед закрывающим тегом, в плагин
встроен хелпер, генерирующий свое событие-хук: `tips_plugin_footer_js`. Чтобы всё работало должна быть поддержка этого
хука со стороны плагинов, которые собираются разместить код, а также со стороны темы дизайна. Без этих двух условий
магия не работает.

### Добавление обработчика хука в вашем плагине

Также, как и для штатных хуков нужно указать функцию-обработчик в конфигурационном файле (`config/plugin.php` вашего 
плагина):

````php
return array(
    /** ... */
    'handlers' => array(
        'tips_plugin_footer_js'=>'footerScripts'
    )
);
````

Название вашего обработчика, конечно, может быть каким угодно, не обязательно `footerScripts`.

### Формат возвращаемого обработчиком ответа

Ваш обработчик хука должен вернуть массив с ключами `links`, `inline_js` и `inline_css`. Все ключи необязательные.

Ключ `links` содержит ссылки на внешние js-скрипты. Он может указывать на строку, тогда это просто ссылка на один скрипт.
Может содержать массив строк, тогда это несколько ссылок на скрипты. Может содержать вложенные массивы со следующей
структурой:

    [
        'uri' => '(путь к скрипту)', // этот ключ обязательный
        'defer' => false, // true или false — нужен ли атрибут defer
        'async' => false, // true или false — нужен ли атрибут async
        'id' => 'строка' // стока, ID вашего скрипта для тега script
    ]

Ключ `inline_js` содержит **строку** с js-кодом, который должен быть обёрнут тегом `script`. Помните, что весь код от всех 
плагинов размещается внутри одного тега script, поэтому не поленитесь поставить точку с запятой в конце вашего кода.

Ключ `inline_css` содержит **строку** со стилями css, которые должны быть обернуты тегом `style`.

Пример обработчика хука:

````php
public function footerScripts() {
    return array(
        'links'     => array(
            '/wa-apps/shop/plugins/myplugin/js/myscript.js',
            array('uri'=>'/wa-apps/shop/plugins/js/myotherscript.js', 'defer'=>true, 'id'=>'s-plugin-otherscript')
        ),
        'inline_js' =>'$(function(){console.log("it works!")});',
        'inline_css'=>'p.myplugin {font-size: 1rem}'
    );
}
````

### Интеграция хелпера в тему дизайна

Рекомендуется добавлять вызов хелпера плагина в шаблон `index.html` прямо перед закрывающим тегом `body`. Тогда, даже
если подключаемые скрипты не используют async/defer, их подключение не будет сказываться на скорости рендеринга страницы.
Да что там, вы и сами знаете наверняка зачем так делать.

Вызвать метод хелпера можно так: `$wa->shop->tipsPlugin->footer_js()` **Shop-Script 8.18+!**

Хелпер вернёт массив с ключами `links`, `inline_js` и `inline_css`. Или пустой массив, если ни один плагин ничего не выводит.
Каждый ключ указывает на массив соответствующих ответов плагинов, где ключи — идентификаторы плагинов с суффиксом '-plugin'. Примерно так

````php
array(
    'links' => array(
        'first-plugin' => array(/* тут массив строк '<script src>....</script>' */),
        'other-plugin' => array(/* тут массив строк '<script src>....</script>' */),   
    ),
    'inline_js' => array(
        'first-plugin' => 'код от плагина first, который надо поместить между тегами <script></script>',
        'other-plugin' => 'код от плагина other, который надо поместить между тегами <script></script>',   
    ),
    'inline_css' => array(
        'first-plugin' => 'код от плагина first, который надо поместить между тегами <style></style>',
        'other-plugin' => 'код от плагина other, который надо поместить между тегами <style></style>',   
    ),
);
````

Пример кода для вставки в шаблон:

````smarty
{if $wa->shop}
    {$footer_js = $wa->shop->tipsPlugin->footer_js()}
    {if $footer_js}{literal}
        {foreach $footer_js.links as $links}{"\n"|implode:$links}{/foreach}
        {if $footer_js.inline_js}
<script>
    {";\n"|implode:$footer_js.inline_js}
</script>
        {/if}
        {foreach $footer_js.inline_css as $css}
<style>
        {$css}
</style>
        {/foreach}
    {/literal}{/if}
{/if}
````

### Что делать владельцу сайта

1. Узнайте у автора темы дизайна, встроена ли поддержка хука нашего плагина в тему дизайна и пришлите ему ссылку на это 
описание. Вы также можете попробовать самостоятельно добавить код в тему дизайна.
2. Узнайте у автора плагина, чей js-код вы хотели бы упорядочить, поддерживает-ли плагин хук нашего плагина и пришлите
ему ссылку на это описание. Самостоятельно встроить поддержку лучше не пробовать.

## Разработчик
(c) 2015-2023, Sergey Rodovnichenko

Пожелания и вопросы отправлять [через форму на сайте](https://www.syrnik.com/support/request/) или по
[e-mail](mailto:support@syrnik.com).
